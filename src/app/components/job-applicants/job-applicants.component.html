<div class="page-wrap">
  <!-- page header row -->
  <div class="page-bar">
    <h1 class="page-title">
      Applicants For<span class="count"
        >{{ jobRow.title }} ({{ dataTable.length }})</span
      >
    </h1>

    <!-- search -->
    <div class="position-relative" style="width: 350px">
      <input
        #searchBox
        type="text"
        class="form-control pe-5"
        placeholder="Search"
        aria-label="Search"
        (keyup)="applyFilter(searchBox.value)"
        (keyup.enter)="applyFilter(searchBox.value)"
      />

      <!-- icon inside the input on the right -->
      <i
        class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3 text-muted search-icon"
        role="button"
        (click)="applyFilter(searchBox.value)"
      ></i>
    </div>
  </div>
  <div class="stage-tabs mb-3">
    <mat-button-toggle-group
      [value]="selectedTab"
      (change)="onTabChange($event.value)"
      appearance="legacy"
    >
      <mat-button-toggle value="Applied">All</mat-button-toggle>
      <mat-button-toggle value="Shortlisted">Shortlisted</mat-button-toggle>
      <mat-button-toggle value="Hired">Hired</mat-button-toggle>
      <mat-button-toggle value="Reviewed">Reviewed</mat-button-toggle>
      <mat-button-toggle value="Rejected">Rejected</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
  <div class="card">
    <table
      class="jobs-table"
      mat-table
      [dataSource]="dataSource"
      matSort
      (matSortChange)="tableSortChange($event)"
      matSortDisableClear
      style="background-color: #fff"
    >
      <!-- Name -->
      <ng-container matColumnDef="name">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          sortActionDescription="Sort"
        >
          <span class="cell-strong">Name</span>
        </th>
        <td mat-cell *matCellDef="let row">{{ row.userName }}</td>
      </ng-container>

      <!-- Email -->
      <ng-container matColumnDef="email">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          sortActionDescription="Sort"
        >
          <span class="cell-strong">Email</span>
        </th>
        <td mat-cell *matCellDef="let row">{{ row.email }}</td>
      </ng-container>

      <!-- City -->
      <ng-container matColumnDef="city">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          sortActionDescription="Sort"
        >
          <span class="cell-strong">City</span>
        </th>
        <td mat-cell *matCellDef="let row">{{ row.city }}</td>
      </ng-container>

      <!-- Country -->
      <ng-container matColumnDef="country">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          sortActionDescription="Sort"
        >
          <span class="cell-strong">Country</span>
        </th>
        <td mat-cell *matCellDef="let row">{{ row.country }}</td>
      </ng-container>

      <!-- Phone Number -->
      <ng-container matColumnDef="phone">
        <th mat-header-cell *matHeaderCellDef>
          <span class="cell-strong">Phone Number</span>
        </th>
        <td mat-cell *matCellDef="let row">{{ row.phone }}</td>
      </ng-container>

      <!-- Resume -->
      <ng-container matColumnDef="resume">
        <th mat-header-cell *matHeaderCellDef>
          <span class="cell-strong">Resume</span>
        </th>
        <td mat-cell *matCellDef="let row">{{ row.resume }}</td>
        <i class="bi bi-cloud-arrow-down"></i>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>
          <span class="cell-strong">Actions</span>
        </th>
        <td mat-cell *matCellDef="let row; let i = index" class="actions">
          <button
            mat-icon-button
            matTooltip="View"
            (click)="openApplicantDetails(i)"
          >
            <i class="bi bi-eye"></i>
          </button>
          <button
            *ngIf="['Applied', 'Reviewed'].includes(selectedTab)"
            mat-icon-button
            matTooltip="Shortlist"
            (click)="
              updateJobApplicantStatus(row, 'Shortlisted');
              $event.stopPropagation()
            "
          >
            <i class="bi bi-person-check"></i>
          </button>
          <button
            *ngIf="['Shortlisted', 'Hired'].includes(selectedTab)"
            mat-icon-button
            matTooltip="Chat"
            (click)="openChat(row)"
          >
            <i class="bi bi-chat-square-text"></i>
          </button>
          <button
            *ngIf="['Shortlisted', 'Hired'].includes(selectedTab)"
            mat-icon-button
            matTooltip="Call"
            (click)="saveMeetingUser(row)"
          >
            <i class="bi bi-camera-video"></i>
          </button>
          <button
            *ngIf="['Applied'].includes(selectedTab)"
            mat-icon-button
            matTooltip="Review"
            (click)="
              updateJobApplicantStatus(row, 'Reviewed');
              $event.stopPropagation()
            "
          >
            <i class="bi bi-file-earmark-check"></i>
          </button>
          <button
            *ngIf="
              ['Applied', 'Shortlisted', 'Hired', 'Reviewed'].includes(
                selectedTab
              )
            "
            mat-icon-button
            matTooltip="Reject"
            class="text-danger"
            (click)="
              updateJobApplicantStatus(row, 'Rejected');
              $event.stopPropagation()
            "
          >
            <i class="bi bi-person-x"></i>
          </button>
        </td>
      </ng-container>

      <!-- header & rows -->
      <tr
        mat-header-row
        *matHeaderRowDef="displayedColumns"
        class="sticky"
      ></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator
      [pageSizeOptions]="getPagingSizeIntervals()"
      showFirstLastButtons
      [length]="totalCount"
      [pageSize]="dataTable.pageSize"
      [pageIndex]="dataTable.pageIndex"
      (page)="handlePage($event)"
    >
    </mat-paginator>

    <!-- <mat-paginator style="background-color: #fff;" [pageSize]="10" [pageSizeOptions]="[5,10,20,50]" showFirstLastButtons></mat-paginator> -->
  </div>
</div>

<app-applicant-details
  [selectedApplicant]="selectedApplicant"
  componentName="JobApplicants"
  (onChangeStatus)="handleApplicantStatus($event)"
  (onCommunicate)="handleCommunication($event)"
>
</app-applicant-details>

<!--Chat pannel-->
<app-chat-pannel
  *ngIf="selectedUserId"
  [userId]="selectedUserId"
  [userName]="selectedUserName"
  (onClose)="selectedUserId = null"
></app-chat-pannel>

<!--Video Meeting Popup-->
<div class="modal fade" id="meetingModal" #meetingModal tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Meeting</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <form [formGroup]="meetingForm" (ngSubmit)="submitForm()">
        <div class="modal-body">
          <!-- Meeting Name -->
          <div class="mb-3">
            <label class="form-label">Meeting Name</label>
            <input
              type="text"
              class="form-control"
              formControlName="meetingName"
            />
            <small
              class="text-danger"
              *ngIf="
                meetingForm.get('meetingName')?.touched &&
                meetingForm.get('meetingName')?.invalid
              "
            >
              Meeting name is required
            </small>
          </div>

          <!-- Start Time -->
          <div class="mb-3">
            <label class="form-label">Start Time</label>
            <input
              type="datetime-local"
              class="form-control"
              formControlName="startTime"
            />
          </div>

          <!-- Duration -->
          <div class="mb-3">
            <label class="form-label">Duration (minutes)</label>
            <input
              type="number"
              class="form-control"
              formControlName="duration"
              min="1"
            />
            <small
              class="text-danger"
              *ngIf="
                meetingForm.get('duration')?.touched &&
                meetingForm.get('duration')?.invalid
              "
            >
              Duration must be at least 1 minute
            </small>
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
